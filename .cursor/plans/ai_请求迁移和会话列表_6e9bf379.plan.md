---
name: AI 请求迁移和会话列表
overview: 将 AI 请求从直接调用 Python 服务改为通过 Spring Boot 代理，并实现 AI 会话列表页面作为"找项目"的入口
todos:
  - id: create-models
    content: 创建 AI 会话相关数据模型（ai_chat_log_model, ai_session_model, ai_query_request_v2）
    status: completed
  - id: update-repository
    content: 更新 AiRepository，新增 Spring Boot 代理方法和历史查询方法
    status: completed
    dependencies:
      - create-models
  - id: create-session-list-provider
    content: 创建 AI 会话列表 Provider（ai_session_list_provider.dart）
    status: completed
    dependencies:
      - update-repository
  - id: update-query-provider
    content: 更新 AiQueryProvider，支持 sessionId 和新接口
    status: completed
    dependencies:
      - update-repository
  - id: create-session-list-page
    content: 创建 AI 会话列表页面（ai_session_list_page.dart）和会话卡片组件
    status: completed
    dependencies:
      - create-session-list-provider
  - id: create-session-detail-page
    content: 创建 AI 会话详情页面（ai_session_detail_page.dart）
    status: completed
    dependencies:
      - update-query-provider
  - id: update-entry-page
    content: 更新 AI 入口页面，点击找项目跳转到会话列表页面
    status: completed
    dependencies:
      - create-session-list-page
  - id: test-integration
    content: 测试完整流程：入口 → 会话列表 → 新建查询 → 查看历史
    status: completed
    dependencies:
      - update-entry-page
      - create-session-detail-page
---

# AI 请求迁移和会话列表实现计划

## 目标

1. 保留原有 AI 查询逻辑（直接调用 Python）
2. 新增通过 Spring Boot 代理的 AI 请求方式
3. 切换默认使用新的请求方式
4. 实现 AI 会话列表页面作为"找项目"的入口
5. 在会话列表页面提供按钮进入原有的 AI 提问页面

## 实施步骤

### 1. 新增数据模型（AI 会话相关）

创建以下新模型：

- `ai_chat_log_model.dart` - AI 聊天记录模型（对应后端 t_ai_chat_log 表）
- `ai_session_model.dart` - AI 会话模型（用于会话列表展示）
- `ai_query_request_v2.dart` - 新版 AI 请求模型（包含 sessionId）

### 2. 更新 AiRepository

在 [`lib/features/ai/data/repositories/ai_repository.dart`](lib/features/ai/data/repositories/ai_repository.dart) 中：

- 保留原有的 `queryProjects` 方法（直接调用 Python）
- 新增 `queryProjectsViaSpringBoot` 方法（通过 Spring Boot 代理）
- 新增 `getAiHistory` 方法（获取对话历史）
- 新增 `getSessionHistory` 方法（获取指定会话记录）
- 使用主 ApiClient 实例（自动带 JWT Token）

### 3. 创建 AI 会话列表页面

创建 `ai_session_list_page.dart`：

- 显示用户的 AI 对话会话列表
- 每个会话显示：最后一次提问内容、时间、项目匹配数
- 点击会话进入会话详情页
- 底部提供"新建查询"按钮，进入原有的 AI 提问页面（`ai_page.dart`）
- 支持下拉刷新和分页加载

### 4. 创建 AI 会话详情页面

创建 `ai_session_detail_page.dart`：

- 显示指定 sessionId 的所有对话记录
- 展示问题和匹配的项目列表
- 可在此页面继续提问（同一会话）

### 5. 更新 Provider

更新 [`lib/features/ai/providers/ai_query_provider.dart`](lib/features/ai/providers/ai_query_provider.dart)：

- 添加 `sessionId` 字段管理
- 更新 `submitQuery` 方法使用新的 Spring Boot 代理接口
- 保留旧方法作为备用

新建 `ai_session_list_provider.dart`：

- 管理会话列表状态
- 支持分页加载
- 支持下拉刷新

### 6. 更新入口页面

修改 [`lib/features/ai/presentation/pages/ai_entry_page.dart`](lib/features/ai/presentation/pages/ai_entry_page.dart)：

- 点击"找项目"按钮跳转到 AI 会话列表页面（而非直接进入提问页面）
- 会话列表页面提供"新建查询"按钮进入原提问页面

### 7. 更新路由配置

在 [`lib/app.dart`](lib/app.dart) 中添加新页面路由（如果使用命名路由）

## 技术要点

### JWT Token 自动携带

使用主 ApiClient 实例调用 Spring Boot API，Token 会自动通过 `Authorization: Bearer <token>` 头部传递。

### API 端点

- 新接口：`POST /api/v1/ai/query`
- 对话历史：`GET /api/v1/ai/history?page=1&size=20`
- 会话记录：`GET /api/v1/ai/session/{sessionId}`

### 会话 ID 生成

使用 UUID 生成唯一的 sessionId，每次新建查询时生成新的 sessionId，后续在同一会话中提问使用相同的 sessionId。

### 兼容性

保留原有的 Python 直接调用方式作为备用，如果 Spring Boot 接口不可用，可以快速切回。

## 文件清单

新建文件：

- `lib/features/ai/data/models/ai_chat_log_model.dart`
- `lib/features/ai/data/models/ai_session_model.dart`
- `lib/features/ai/data/models/ai_query_request_v2.dart`
- `lib/features/ai/presentation/pages/ai_session_list_page.dart`
- `lib/features/ai/presentation/pages/ai_session_detail_page.dart`
- `lib/features/ai/presentation/widgets/ai_session_card.dart`
- `lib/features/ai/providers/ai_session_list_provider.dart`

修改文件：

- `lib/features/ai/data/repositories/ai_repository.dart`
- `lib/features/ai/providers/ai_query_provider.dart`
- `lib/features/ai/presentation/pages/ai_entry_page.dart`