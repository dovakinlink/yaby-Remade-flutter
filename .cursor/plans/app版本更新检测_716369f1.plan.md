---
name: APP版本更新检测
overview: 在 APP 启动时检测版本更新，根据服务端返回的更新策略显示可选更新或强制更新对话框，支持跳转应用商店或直接下载 APK。
todos:
  - id: add-dependency
    content: 添加 package_info_plus 依赖到 pubspec.yaml
    status: completed
  - id: create-model
    content: 创建 AppUpdateCheckVO 数据模型
    status: completed
    dependencies:
      - add-dependency
  - id: create-service
    content: 创建 AppUpdateService 更新检测服务
    status: completed
    dependencies:
      - create-model
  - id: create-dialog
    content: 创建 AppUpdateDialog 更新对话框组件
    status: completed
    dependencies:
      - create-model
  - id: integrate
    content: 在 _AppInitializer 中集成更新检测逻辑
    status: completed
    dependencies:
      - create-service
      - create-dialog
---

# APP 版本更新检测功能实现

## 架构设计

```mermaid
flowchart TB
    subgraph init [应用启动流程]
        A[_AppInitializer] --> B[恢复会话]
        B --> C{用户已登录?}
        C -->|是| D[检测版本更新]
        D --> E{有更新?}
        E -->|是 强制| F[显示强制更新对话框]
        E -->|是 可选| G[显示可选更新对话框]
        E -->|否| H[继续进入首页]
        F --> I[跳转商店/下载APK]
        G --> J{用户选择}
        J -->|更新| I
        J -->|稍后| H
    end
```

## 实现步骤

### 1. 添加依赖

修改 [pubspec.yaml](pubspec.yaml)，添加 `package_info_plus` 用于获取运行时版本信息。

### 2. 创建数据模型

新建 `lib/features/app_update/data/models/app_update_check_vo.dart`：

- 包含 `hasUpdate`、`force`、`latestVersionName`、`storeUrl`、`downloadUrl`、`releaseNotes` 等字段

### 3. 创建更新服务

新建 `lib/features/app_update/data/services/app_update_service.dart`：

- 调用 `POST /api/app/update/check` 接口
- 使用硬编码的 `appKey: yaby_app`
- 根据平台设置 `channelCode`: Android 为 `official`，iOS 为 `appstore`
- 通过 `package_info_plus` 获取 `versionName` 和 `buildNumber`
- 通过 `device_info_plus` 获取 `deviceId`

### 4. 创建更新对话框

新建 `lib/features/app_update/presentation/widgets/app_update_dialog.dart`：

- 显示版本号、更新说明列表
- 强制更新模式：只有"立即更新"按钮，不可关闭
- 可选更新模式："立即更新"和"稍后提醒"按钮
- 点击更新：iOS 跳转 App Store，Android 优先使用 `downloadUrl` 下载 APK，无则跳转商店

### 5. 集成到启动流程

修改 [lib/app.dart](lib/app.dart) 中的 `_AppInitializer`：

- 在用户登录成功跳转首页后，调用更新检测
- 根据返回结果显示对应的更新对话框