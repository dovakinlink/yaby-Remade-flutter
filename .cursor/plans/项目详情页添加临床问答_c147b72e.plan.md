---
name: é¡¹ç›®è¯¦æƒ…é¡µæ·»åŠ ä¸´åºŠé—®ç­”
overview: åœ¨é¡¹ç›®è¯¦æƒ…é¡µé¢æ·»åŠ æµ®åŠ¨æŒ‰é’®ï¼Œç‚¹å‡»åç›´æ¥è¿›å…¥é’ˆå¯¹è¯¥é¡¹ç›®çš„ä¸´åºŠé—®ç­”å¯¹è¯ï¼Œè·³è¿‡æ‚£è€…æŸ¥è¯¢å’Œé¡¹ç›®é€‰æ‹©é˜¶æ®µ
todos:
  - id: extend-provider-init
    content: æ‰©å±•XiaobaiChatProvideræ·»åŠ initFromProjectæ–¹æ³•
    status: completed
  - id: create-project-chat-page
    content: åˆ›å»ºXiaobaiProjectChatPageé¡µé¢
    status: completed
    dependencies:
      - extend-provider-init
  - id: update-project-detail
    content: ä¿®æ”¹ProjectDetailPageæ·»åŠ æµ®åŠ¨æŒ‰é’®å’Œå¯¼èˆªé€»è¾‘
    status: completed
    dependencies:
      - create-project-chat-page
---

# é¡¹ç›®è¯¦æƒ…é¡µæ·»åŠ ä¸´åºŠé—®ç­”åŠŸèƒ½

## ç›®æ ‡

åœ¨é¡¹ç›®è¯¦æƒ…é¡µé¢ï¼ˆ`ProjectDetailPage`ï¼‰æ·»åŠ ä¸€ä¸ªæµ®åŠ¨æŒ‰é’®ï¼Œç‚¹å‡»åè¿›å…¥"ä¸´åºŠé—®ç­”"ç•Œé¢ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä¸å°ç™½ AI å°±è¯¥é¡¹ç›®è¿›è¡Œå¯¹è¯ï¼Œæ— éœ€è¾“å…¥æ‚£è€…ä¿¡æ¯ã€‚

## å®æ–½æ­¥éª¤

### 1. ä¿®æ”¹ XiaobaiChatProvider æ”¯æŒä»é¡¹ç›®ç›´æ¥åˆå§‹åŒ–

**æ–‡ä»¶**: [`lib/features/ai/providers/xiaobai_chat_provider.dart`](lib/features/ai/providers/xiaobai_chat_provider.dart)æ–°å¢æ–¹æ³• `initFromProject()`ï¼Œç”¨äºä»é¡¹ç›®è¯¦æƒ…é¡µç›´æ¥è¿›å…¥èŠå¤©é˜¶æ®µï¼š

```dart
/// ä»é¡¹ç›®ç›´æ¥åˆå§‹åŒ–ï¼ˆç”¨äºé¡¹ç›®è¯¦æƒ…é¡µï¼‰
/// è·³è¿‡æ‚£è€…æŸ¥è¯¢å’Œé¡¹ç›®é€‰æ‹©é˜¶æ®µï¼Œç›´æ¥è¿›å…¥å¯¹è¯
void initFromProject({
  required int projectId,
  required String projectName,
  String? projectShortTitle,
}) {
  _sessionId = _uuid.v4();
  _patientIdentifier = ''; // ä¸éœ€è¦æ‚£è€…ä¿¡æ¯
  
  // åˆ›å»ºè™šæ‹Ÿé¡¹ç›®å¯¹è±¡
  _selectedProject = XiaobaiPatientProject(
    projectId: projectId,
    projectName: projectName,
    shortTitle: projectShortTitle ?? projectName,
    patientInNo: '',
    patientNameAbbr: '',
    statusCode: '',
    statusText: '',
  );
  
  _messages = [];
  _chatError = null;
  _isSendingMessage = false;
  _inputText = '';
  
  notifyListeners();
}
```

å…³é”®ç‚¹ï¼š

- ç”Ÿæˆæ–°çš„ sessionId
- ä¸è®¾ç½®æ‚£è€…æ ‡è¯†ï¼ˆpatientIdentifier ä¸ºç©ºï¼‰
- åˆ›å»ºé¡¹ç›®å¯¹è±¡ä»¥ä¾¿å‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨
- `currentStage` ä¼šè¿”å› 3ï¼ˆå¯¹è¯é˜¶æ®µï¼‰

### 2. åˆ›å»ºé¡¹ç›®ä¸´åºŠé—®ç­”é¡µé¢

**æ–°å»º**: `lib/features/ai/presentation/pages/xiaobai_project_chat_page.dart`è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ä¸´åºŠé—®ç­”é¡µé¢ï¼Œä¸“é—¨ç”¨äºä»é¡¹ç›®è¯¦æƒ…é¡µè¿›å…¥ï¼š

```dart
class XiaobaiProjectChatPage extends StatefulWidget {
  const XiaobaiProjectChatPage({
    super.key,
    required this.projectId,
    required this.projectName,
  });

  final int projectId;
  final String projectName;
  
  // ...
}
```

é¡µé¢ç»“æ„ï¼š

- é¡¶éƒ¨ï¼šæ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯å¡ç‰‡ï¼ˆå¯ç‚¹å‡»è¿”å›é¡¹ç›®è¯¦æƒ…ï¼‰
- ä¸­é—´ï¼šèŠå¤©è®°å½•åˆ—è¡¨
- åº•éƒ¨ï¼šè¾“å…¥æ¡†

### 3. ä¿®æ”¹é¡¹ç›®è¯¦æƒ…é¡µé¢

**æ–‡ä»¶**: [`lib/features/home/presentation/pages/project_detail_page.dart`](lib/features/home/presentation/pages/project_detail_page.dart)

#### 3.1 æ·»åŠ æµ®åŠ¨æŒ‰é’®ç»„

å½“å‰é¡µé¢å·²æœ‰ä¸€ä¸ªæµ®åŠ¨æŒ‰é’®ç”¨äº"ç­›æŸ¥æ‚£è€…"ï¼Œéœ€è¦æ”¹ä¸ºæµ®åŠ¨æŒ‰é’®ç»„ï¼ŒåŒ…å«ä¸¤ä¸ªæŒ‰é’®ï¼š

1. ç­›æŸ¥æ‚£è€…ï¼ˆåŸæœ‰ï¼‰
2. ä¸´åºŠé—®ç­”ï¼ˆæ–°å¢ï¼‰

ä½¿ç”¨ `Column` + `FloatingActionButton` ç»„åˆï¼Œæˆ–ä½¿ç”¨é€Ÿæ‹¨èœå•ï¼ˆSpeed Dialï¼‰ã€‚**æ¨èæ–¹æ¡ˆ**ï¼šä½¿ç”¨ç®€å•çš„ Column å¸ƒå±€

```dart
floatingActionButton: provider.project != null
    ? Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.end,
        children: [
          // ä¸´åºŠé—®ç­”æŒ‰é’®
          FloatingActionButton.extended(
            onPressed: () => _openXiaobaiChat(),
            heroTag: 'xiaobai_chat',
            backgroundColor: Colors.blue,
            icon: const Icon(Icons.chat, color: Colors.white),
            label: const Text(
              'ä¸´åºŠé—®ç­”',
              style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600),
            ),
          ),
          const SizedBox(height: 12),
          // ç­›æŸ¥æ‚£è€…æŒ‰é’®ï¼ˆåŸæœ‰ï¼‰
          if (provider.project!.hasCriteria)
            FloatingActionButton.extended(
              onPressed: () => _navigateToScreening(),
              heroTag: 'screening',
              backgroundColor: AppColors.brandGreen,
              icon: const Icon(Icons.person_add, color: Colors.white),
              label: const Text(
                'ç­›æŸ¥æ‚£è€…',
                style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600),
              ),
            ),
        ],
      )
    : null,
```



#### 3.2 æ·»åŠ å¯¼èˆªæ–¹æ³•

```dart
void _openXiaobaiChat() {
  final project = context.read<ProjectDetailProvider>().project;
  if (project == null) return;
  
  final repository = context.read<AiRepository>();
  Navigator.of(context).push(
    MaterialPageRoute(
      builder: (_) => ChangeNotifierProvider(
        create: (_) => XiaobaiChatProvider(repository)
          ..initFromProject(
            projectId: project.id,
            projectName: project.projName,
            projectShortTitle: project.shortTitle,
          ),
        child: XiaobaiProjectChatPage(
          projectId: project.id,
          projectName: project.projName,
        ),
      ),
    ),
  );
}
```



### 4. UI è®¾è®¡è¯´æ˜

#### æµ®åŠ¨æŒ‰é’®ä½ç½®

```javascript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚
â”‚   é¡¹ç›®è¯¦æƒ…å†…å®¹       â”‚
â”‚                     â”‚
â”‚                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚            â”‚ğŸ’¬é—®ç­” â”‚ â”‚  â† è“è‰²
â”‚            â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚            â”‚ğŸ‘¤ç­›æŸ¥ â”‚ â”‚  â† ç»¿è‰²
â”‚            â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



#### ä¸´åºŠé—®ç­”é¡µé¢å¸ƒå±€

```javascript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† ä¸´åºŠé—®ç­”                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ é£Ÿç®¡ç™Œå…ç–«æ²»ç–—ä¸´åºŠç ”ç©¶    â†’ â”‚  â† å¯ç‚¹å‡»å›åˆ°é¡¹ç›®è¯¦æƒ…
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚
â”‚ èŠå¤©è®°å½•åŒºåŸŸ                 â”‚
â”‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [è¾“å…¥æ¡†]              [å‘é€] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



## æŠ€æœ¯è¦ç‚¹

1. **ä¸ä¼ å…¥æ‚£è€…ä¿¡æ¯**ï¼šåœ¨è°ƒç”¨ `askXiaobai` æ—¶ï¼Œ`patientName` å‚æ•°ä¸º null
2. **è·³è¿‡å‰ä¸¤ä¸ªé˜¶æ®µ**ï¼šä½¿ç”¨ `initFromProject()` ç›´æ¥è®¾ç½® `_selectedProject`ï¼Œè®© `currentStage` è¿”å› 3
3. **ä¼šè¯ç®¡ç†**ï¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„ sessionIdï¼Œåç»­å¯¹è¯ä½¿ç”¨åŒä¸€ä¸ª sessionId
4. **é¡¹ç›®ä¿¡æ¯å±•ç¤º**ï¼šåœ¨å¯¹è¯é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºå½“å‰é¡¹ç›®ï¼Œå¹¶æ”¯æŒç‚¹å‡»è¿”å›é¡¹ç›®è¯¦æƒ…

## API è°ƒç”¨

```javascript
POST /api/v1/ai/xiaobai/ask
{
  "question": "ç”¨æˆ·é—®é¢˜",
  "projectId": 38,
  "patientName": null,  // ä¸ä¼ å…¥æ‚£è€…ä¿¡æ¯
  "sessionId": "session-xxx"
}
```



## ä¾èµ–å…³ç³»

- âœ… XiaobaiChatProvider å·²æœ‰å®Œæ•´çš„æ¶ˆæ¯å‘é€é€»è¾‘
- âœ… XiaobaiChatMessage ç»„ä»¶å¯å¤ç”¨
- âœ… AiRepository.askXiaobai() å·²æ”¯æŒå¯é€‰çš„ patientName å‚æ•°