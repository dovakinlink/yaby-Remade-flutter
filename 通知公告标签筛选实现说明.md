# 通知公告标签筛选功能实现说明

## 实现日期
2025-10-25

## 功能概述
在首页通知公告列表上方增加标签筛选UI，用户可以通过点击不同的标签按钮来筛选通知公告。

## 实现的功能

✅ **标签筛选器UI**：横向滚动的标签按钮列表  
✅ **"全部"选项**：默认显示所有通知公告  
✅ **单选模式**：一次只能选择一个标签  
✅ **视觉反馈**：选中的标签显示品牌绿背景，未选中只显示边框  
✅ **自动刷新**：切换标签时自动重新加载列表数据  
✅ **加载状态**：标签加载时显示加载指示器  
✅ **深色模式支持**：完美适配浅色和深色主题  

## API接口

### 获取标签列表
**接口**: `GET /api/v1/announcements/tags`

**响应格式**:
```json
{
  "code": "SUCCESS",
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "tagCode": "case_discussion",
      "tagName": "病例讨论",
      "description": "分享和讨论临床病例",
      "orderNo": 1
    }
  ]
}
```

### 筛选公告列表
**接口**: `GET /api/v1/announcements/home`

**请求参数**:
- `page`: 页码
- `size`: 每页数量
- `tag-id`: 标签ID（可选，不传则显示全部）

## 实现的文件

### 1. 数据模型
**文件**: `lib/features/home/data/models/notice_tag_model.dart`

通知公告标签数据模型：
```dart
class NoticeTagModel {
  final int id;
  final String tagCode;
  final String tagName;
  final String description;
  final int orderNo;
}
```

### 2. Repository 层
**文件**: `lib/features/home/data/repositories/announcement_repository.dart`

新增方法：
```dart
/// 获取通知公告标签列表
Future<List<NoticeTagModel>> fetchAnnouncementTags()
```

修改方法：
```dart
/// 首页公告列表（支持标签筛选）
Future<PageResponse<AnnouncementModel>> fetchHomeAnnouncements({
  int page = 1,
  int size = 10,
  int? noticeType,
  int? status,
  int? tagId,  // 新增参数
})
```

### 3. Provider 层
**文件**: `lib/features/home/providers/home_announcements_provider.dart`

新增字段：
```dart
List<NoticeTagModel> _tags = [];  // 标签列表
bool _isTagLoading = false;        // 标签加载状态
int? _selectedTagId;               // 选中的标签ID
```

新增方法：
```dart
/// 加载标签列表
Future<void> loadAnnouncementTags({bool force = false})

/// 应用标签筛选
Future<void> applyTagFilter(int? tagId)
```

### 4. UI 组件
**文件**: `lib/features/home/presentation/widgets/notice_tag_filter.dart`

标签筛选器组件：
```dart
class NoticeTagFilter extends StatelessWidget {
  final List<NoticeTagModel> tags;
  final int? selectedTagId;
  final ValueChanged<int?> onTagSelected;
  final bool isLoading;
}
```

设计规范：
- **选中状态**：品牌绿背景 (#36CAC4) + 白色文字
- **未选中状态**：白色/透明背景 + 黑色边框 + 深色文字
- **圆角**：18px
- **内边距**：水平14px，垂直6px
- **高度**：44px
- **间距**：按钮间距12px

### 5. 页面集成
**文件**: `lib/features/home/presentation/pages/home_page.dart`

修改内容：
1. 导入 `notice_tag_filter.dart`
2. 在 `initState` 中调用 `loadAnnouncementTags()`
3. 添加 `_buildTagFilterSlivers()` 方法渲染标签筛选器

布局结构：
```
首页
├── 顶部导航
├── 搜索栏和统计卡片
├── 标签筛选器 ← 新增
├── 通知公告列表
└── 底部导航栏
```

## UI 设计

### 标签筛选器布局
```
┌────────────────────────────────────────┐
│  [全部] [病例讨论] [经验分享] [学术交流] → │
└────────────────────────────────────────┘
```

### 选中状态示例
```
[全部]  选中：品牌绿背景 + 白色文字
[病例讨论]  未选中：白色背景 + 黑色边框 + 深色文字
```

## 交互流程

1. **初始加载**
   ```
   用户打开首页 
   → 自动加载标签列表
   → 显示标签筛选器
   → 默认选中"全部"
   → 加载所有通知公告
   ```

2. **选择标签**
   ```
   用户点击某个标签
   → 更新选中状态（视觉反馈）
   → 调用 applyTagFilter(tagId)
   → 重新加载公告列表（带 tag-id 参数）
   → 显示筛选后的公告
   ```

3. **选择"全部"**
   ```
   用户点击"全部"
   → 清除标签筛选（tagId = null）
   → 重新加载所有公告
   ```

4. **滚动加载更多**
   ```
   用户滚动到底部
   → 保持当前标签筛选
   → 加载下一页数据（带相同的 tag-id）
   ```

## 调试日志

实现中添加了详细的调试日志，便于排查问题：

### Repository 层
```
AnnouncementRepository: 请求标签列表 /api/v1/announcements/tags
AnnouncementRepository: 标签API响应 - statusCode: 200
AnnouncementRepository: code=SUCCESS, message=操作成功
AnnouncementRepository: 成功获取 3 个标签
  - 标签: 病例讨论 (ID: 1, Code: case_discussion)
  - 标签: 经验分享 (ID: 2, Code: experience_share)
```

### Provider 层
```
HomeAnnouncementsProvider: 开始加载标签列表
HomeAnnouncementsProvider: 成功加载 3 个标签
HomeAnnouncementsProvider: 应用标签筛选 - tagId: 1
```

### 页面层
```
HomePage: 选择标签 - tagId: 1
```

## 测试步骤

### 1. 功能测试

```bash
# 运行应用
flutter run
```

**测试检查点**：
- [ ] 首页加载时标签筛选器正确显示
- [ ] 默认显示"全部"和所有标签选项
- [ ] "全部"选项默认被选中（品牌绿背景）
- [ ] 点击某个标签，该标签变为选中状态
- [ ] 点击标签后，列表数据正确更新
- [ ] 切换标签时，加载状态正确显示
- [ ] 标签筛选后，滚动加载更多保持筛选条件

### 2. UI 测试

**浅色模式**：
- [ ] 选中标签：品牌绿背景 + 白色文字
- [ ] 未选中标签：白色背景 + 黑色边框 + 深色文字
- [ ] 标签按钮圆角和内边距正确

**深色模式**：
- [ ] 选中标签：品牌绿背景 + 白色文字
- [ ] 未选中标签：透明背景 + 灰色边框 + 浅色文字
- [ ] 深色主题下视觉效果良好

### 3. 边界情况测试

- [ ] 标签列表为空时，仍显示"全部"选项
- [ ] 标签加载失败时，不影响公告列表显示
- [ ] 网络断开时，标签筛选器仍可交互
- [ ] 标签名称过长时，文字正确显示

## 常见问题

### Q: 标签筛选器不显示？
**A**: 检查以下几点：
1. 查看控制台日志，确认标签列表是否成功加载
2. 确认 API 接口 `/api/v1/announcements/tags` 可访问
3. 检查 Provider 是否正确初始化

### Q: 点击标签后列表没有更新？
**A**: 
1. 查看控制台日志中的"应用标签筛选"消息
2. 确认 API 接口支持 `tag-id` 参数
3. 检查后端标签筛选逻辑是否正确

### Q: 标签显示但数据不对？
**A**:
1. 确认后端返回的标签数据格式正确
2. 检查标签的 `orderNo` 字段（用于排序）
3. 验证标签的 `id` 和 `tagCode` 字段

## 性能优化

### 1. 标签列表缓存
标签列表在首次加载后会缓存在 Provider 中，避免重复请求：
```dart
if (_tags.isNotEmpty && !force) {
  return;  // 使用缓存
}
```

### 2. 防抖处理
标签切换时自动防止重复点击：
```dart
if (_selectedTagId == tagId && _announcements.isNotEmpty) {
  return;  // 避免重复刷新
}
```

### 3. 请求ID机制
使用请求ID防止并发请求导致的数据混乱：
```dart
final currentRequestId = ++_requestId;
// ...
if (currentRequestId != _requestId) {
  return;  // 丢弃过期请求的响应
}
```

## 后续优化建议

- [ ] 添加标签统计数字（如"病例讨论 (12)"）
- [ ] 支持标签搜索功能
- [ ] 添加标签收藏功能
- [ ] 支持标签拖拽排序
- [ ] 添加标签管理页面

## 相关文档

- [通知公告标签列表API说明](API_DOC/ANNOUNCEMENT_TAGS_API.md)
- [通知公告标签筛选功能说明](API_DOC/ANNOUNCEMENT_TAG_FILTER.md)
- [API文档](API_DOC/API-Documentation.md)

## 总结

此次实现完整地为首页通知公告列表添加了标签筛选功能，主要特点：

✅ **完整实现**：从数据模型到UI组件的完整链路  
✅ **用户友好**：直观的标签选择器，单选模式  
✅ **视觉规范**：符合设计稿的样式要求  
✅ **性能优化**：标签缓存、防抖、请求ID机制  
✅ **调试友好**：详细的日志输出，便于排查问题  
✅ **主题支持**：完美适配浅色和深色主题  

功能已完整实现，可以正常使用！🎉

