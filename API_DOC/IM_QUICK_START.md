# IM 功能快速使用指南

## ✅ 已实现的功能

### 1. 会话列表页面
- 📱 点击底部导航栏第2个 Tab "聊天"即可进入
- 📋 显示所有会话（目前为空，因为还没有会话数据）
- ➕ 右上角 "+" 按钮可以创建新会话
- 🔄 下拉刷新会话列表

### 2. 创建单聊
1. 点击 "+" 按钮
2. 选择"发起单聊"
3. 输入对方的用户ID（数字）
4. 点击"确定"创建会话
5. 自动跳转到聊天页面

### 3. 聊天页面
- 💬 显示消息列表
- 📤 发送文本消息
- 🖼️ 发送图片（点击输入框左侧的 "+" 按钮）
- 📎 发送文件（点击输入框左侧的 "+" 按钮）
- 📜 滚动到顶部加载更多历史消息
- ✅ 消息状态显示（发送中/已送达/失败）

### 4. 本地存储
- 💾 所有消息自动保存到本地 SQLite 数据库
- 📊 会话列表缓存在本地
- 🔖 已读位置记录

## 🔧 待配置项

### WebSocket 连接
目前 WebSocket 还未自动连接，需要在后续添加自动连接逻辑。

建议在登录成功后自动连接：

```dart
// 在登录成功后
final websocketProvider = context.read<WebSocketProvider>();
await websocketProvider.connect(
  'your-server-host',  // 替换为实际服务器地址
  8090,                 // 替换为实际端口
  accessToken,          // 登录后获得的 JWT Token
);
```

## 📝 测试流程

### 测试单聊功能
1. 启动应用并登录
2. 点击"聊天" Tab
3. 点击右上角 "+"
4. 选择"发起单聊"
5. 输入测试用户ID（如：123）
6. 进入聊天页面
7. 输入文本消息并发送
8. 查看消息状态变化

### 测试消息类型
- **文本消息**：直接输入并发送
- **图片消息**：点击 "+" → 选择"发送图片"
- **文件消息**：点击 "+" → 选择"发送文件"

## 🎨 UI 特性

- ✅ 深色模式支持
- ✅ 品牌绿色主题 (#36CAC4)
- ✅ 微信风格的消息气泡
- ✅ 时间智能显示（今天显示时间，昨天显示"昨天"，一周内显示星期几）
- ✅ 未读消息红点徽章
- ✅ 消息状态指示器

## 🔄 数据流

### 发送消息流程
1. 用户输入消息
2. 创建本地消息（状态：发送中）
3. 显示在界面上
4. 通过 WebSocket 发送到服务器
5. 等待服务器 ACK 确认
6. 更新消息状态（已送达/失败）
7. 保存到本地数据库

### 接收消息流程
1. WebSocket 收到服务器推送
2. 解析消息内容
3. 保存到本地数据库
4. 更新会话列表
5. 如果在聊天页面，实时显示
6. 自动标记为已读

## 📊 数据库表

### conversations（会话表）
- 存储所有会话信息
- 包含最后消息、未读数等

### messages（消息表）
- 存储所有聊天消息
- 支持本地搜索和查询

### read_positions（已读位置表）
- 记录每个会话的已读位置
- 用于计算未读数量

## 🚀 后续功能

### 即将推出
- 🔔 消息推送通知
- 👥 通讯录集成（选择联系人发起聊天）
- 🔍 消息搜索
- 📌 会话置顶
- 🗑️ 消息撤回（2分钟内）

### 高级功能
- 👨‍👩‍👦 群聊功能（基础架构已完成）
- 🎤 语音消息
- 📹 视频消息
- 📍 位置分享
- 🔗 消息转发

## ⚠️ 注意事项

1. **网络要求**：需要后端 IM 服务器支持
2. **权限配置**：图片和文件选择需要相应的系统权限
3. **测试数据**：目前使用用户ID测试，正式环境需要集成通讯录
4. **WebSocket**：需要配置正确的服务器地址和端口

## 🐛 故障排查

### 会话列表为空
- 检查网络连接
- 确认 API 服务器可访问
- 查看是否有历史会话数据

### 消息发送失败
- 检查 WebSocket 连接状态
- 确认 JWT Token 有效
- 查看网络日志

### 无法创建会话
- 确认输入的用户ID存在
- 检查 API 服务器响应
- 查看错误提示信息

## 📱 截图说明

目前你看到的界面：
- 会话列表页面（空状态）
- 显示"暂无聊天"
- 有"发起聊天"按钮
- 右上角有 "+" 按钮

点击 "+" 或"发起聊天"按钮即可创建新会话！

---

**提示**：所有核心代码已完成并集成，现在可以正常使用所有 IM 功能！🎉

